apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    k8s-service: alloy
  name: alloy
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-service: alloy
  template:
    metadata:
      labels:
        k8s-service: alloy
    spec:
      containers:
        - name: alloy
          image: "{{ .Values.alloy.image.repository }}:{{ .Values.alloy.image.tag }}"
          command: [
           "alloy",
           "outofband",
           "--store",
           "serverservice",
           "--controller-mode",
           "--config",
           "/etc/alloy/config.yaml",
           "--enable-pprof",
          ]
          volumeMounts:
            - name: config-volume
              mountPath: /etc/alloy
            - name: nats-creds-volume
              mountPath: /etc/nats
          env:
            - name: ALLOY_NATS_CREDS_FILE
              value: /etc/nats/nats.creds
            - name: SERVERSERVICE_ENDPOINT
              value: "{{ .Values.alloy.env.SERVERSERVICE_ENDPOINT }}"
            - name: SERVERSERVICE_SKIP_OAUTH
              value: "{{ .Values.alloy.env.SERVERSERVICE_SKIP_OAUTH }}"
            - name: SERVERSERVICE_FACILITY_CODE
              value: "{{ .Values.alloy.env.SERVERSERVICE_FACILITY_CODE }}"
            - name: ALLOY_NATS_URL
              value: "{{ .Values.alloy.env.ALLOY_NATS_URL }}"
            - name: ALLOY_NATS_STREAM_USER
              value: "{{ .Values.alloy.env.ALLOY_NATS_STREAM_USER }}"
            - name: ALLOY_NATS_STREAM_PASS
              value: "{{ .Values.alloy.env.ALLOY_NATS_STREAM_PASS }}"
          resources:
            limits:
              cpu: 200m
              memory: 200M
            requests:
              cpu: 200m
              memory: 200M
      volumes:
        - name: config-volume
          configMap:
            name: alloy-config
        - name: nats-creds-volume
          configMap:
            name: alloy-nats-creds
      restartPolicy: Always
